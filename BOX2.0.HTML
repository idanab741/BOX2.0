<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ארנק חכם – v12 (RLS)</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --card:#0E1520; --page:linear-gradient(to bottom,#0b1020,#0d1324);
      --ink:#e6e7eb; --muted:#9aa5b1; --accent:#10b981; --warn:#f59e0b; --danger:#ef4444; --radius:16px; --tap:44px;
    }
    html{font-size:16px}
    body{font-family:'Rubik',ui-sans-serif,system-ui; background:var(--page); color:var(--ink);
         -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
         padding-bottom:calc(env(safe-area-inset-bottom) + 56px);}
    .container{max-width:28rem;margin-inline:auto}
    .card{border-radius:var(--radius);background:var(--card);box-shadow:0 12px 30px rgba(0,0,0,.35)}
    .chip{border-radius:9999px;padding:.35rem .6rem;background:#0f172a;color:#a7f3d0;font-weight:600;font-size:.8rem;border:1px solid rgba(16,185,129,.35)}
    .row{min-height:var(--tap); padding:.55rem .75rem; border-radius:12px}
    .row:hover{background:#0f172a}
    .btn{border-radius:12px; font-weight:700; min-height:var(--tap); padding:.625rem .9rem}
    .btn-prim{background:var(--accent);color:#001b12}
    .btn-ghost{background:#0f172a;color:var(--ink);border:1px solid rgba(255,255,255,.06)}
    .btn-danger{background:#7f1d1d;color:#fecaca;border:1px solid rgba(239,68,68,.45)}
    .kpi{background:#0f172a;border-radius:14px;padding:.55rem .75rem}
    .seg{background:#0f172a;padding:4px;border-radius:12px;display:flex;gap:4px;border:1px solid rgba(255,255,255,.06)}
    .seg button{flex:1;border-radius:10px;padding:.5rem .75rem;font-weight:700;color:#cbd5e1;font-size:.9rem}
    .seg .on{background:var(--card);color:#a7f3d0;box-shadow:0 1px 2px rgba(0,0,0,.25);border:1px solid rgba(16,185,129,.35)}
    .input{border-radius:12px;border:1px solid rgba(255,255,255,.08);background:#0f172a;color:#0be5b3;padding:.75rem .85rem;min-height:var(--tap)}
    .progress{height:8px;border-radius:999px;background:#1f2937;overflow:hidden}
    .progress > div{height:100%;background:var(--accent)}
    *{touch-action:manipulation} ::placeholder{color:#64748b} :focus-visible{outline:3px solid #34d399; outline-offset:2px}
  </style>
</head>
<body>
  <main class="container p-3 space-y-4" aria-live="polite">
    <!-- AUTH MODAL (Email OTP) -->
    <div id="authModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 hidden" role="dialog" aria-modal="true" aria-labelledby="authTitle">
      <div class="card w-[92%] max-w-[520px] p-5">
        <h2 id="authTitle" class="text-lg font-bold mb-2">התחברות מאובטחת</h2>
        <p class="text-sm text-slate-400 mb-4">הכנס/י אימייל ונשלח קוד בן 6 ספרות.</p>
        <form id="authStepEmail" class="grid grid-cols-1 gap-2" novalidate>
          <input id="authEmail" class="input" type="email" placeholder="you@example.com" inputmode="email" required />
          <button id="sendOtpBtn" type="submit" class="btn btn-prim">שלח קוד</button>
          <div id="authEmailErr" class="text-red-400 text-sm hidden" role="alert"></div>
        </form>
        <form id="authStepCode" class="grid grid-cols-1 gap-2 hidden" novalidate>
          <input id="authCode" class="input text-center tracking-[.35em]" maxlength="6" pattern="^[0-9]{6}$" inputmode="numeric" placeholder="••••••" />
          <button id="verifyOtpBtn" type="submit" class="btn btn-prim">אמת קוד</button>
          <div class="flex items-center justify-between text-xs text-slate-400">
            <button id="resendOtpBtn" class="underline" type="button">שלח שוב</button>
            <button id="switchEmailBtn" class="underline" type="button">אימייל אחר</button>
          </div>
          <div id="authCodeErr" class="text-red-400 text-sm hidden" role="alert"></div>
        </form>
        <div id="deviceErr" class="text-red-400 text-sm mt-2 hidden"></div>
      </div>
    </div>

    <!-- TOP BAR -->
    <section class="card p-4">
      <div class="flex items-center justify-between">
        <h1 class="text-[clamp(1rem,3.6vw,1.2rem)] font-bold">ארנק חכם</h1>
        <div class="flex items-center gap-2">
          <button id="btnExportCSV" class="chip text-xs" type="button">CSV</button>
          <button id="btnMonthPicker" class="chip text-xs" type="button">בחר חודש ▾</button>
        </div>
      </div>
      <div id="currentMonthLabel" class="text-[.72rem] text-slate-400 mt-2"></div>
    </section>

    <!-- MAIN TABS -->
    <nav id="mainTabs" class="seg card p-1" role="tablist" aria-label="ניווט">
      <button class="on" role="tab" aria-selected="true" aria-controls="view-home" data-view="home" type="button">בית</button>
      <button role="tab" aria-selected="false" aria-controls="view-expenses" data-view="expenses" type="button">תנועות</button>
      <button role="tab" aria-selected="false" aria-controls="view-savings" data-view="savings" type="button">חיסכון</button>
    </nav>

    <!-- VIEW: HOME -->
    <section id="view-home" class="space-y-4" data-view-panel="home">
      <section class="card p-4">
        <div class="flex items-center justify-between">
          <h3 class="text-[.95rem] font-semibold">סקירה חודשית</h3>
          <button id="btnBudgetQuickEdit" class="chip text-xs" type="button">תקציב חודשי ▾</button>
        </div>
        <div class="grid grid-cols-2 gap-2 text-[.9rem] mt-3">
          <div class="kpi flex items-center justify-between"><span class="text-slate-400">הוצאות</span><b id="kpiCurExp">₪0</b></div>
          <div class="kpi flex items-center justify-between"><span class="text-slate-400">תקציב</span><b id="kpiBudget">₪0</b></div>
          <div class="kpi flex items-center justify-between"><span class="text-slate-400">עודף</span><b id="kpiSurplus">₪0</b></div>
          <div class="kpi flex items-center justify-between"><span class="text-slate-400">עו"ש</span><b id="kpiOverdraft">₪0</b></div>
          <div class="kpi flex items-center justify-between"><span class="text-slate-400">חיסכון</span><b id="kpiSavingsTotal">₪0</b></div>
          <div class="kpi flex items-center justify-between"><span class="text-slate-400">פנסיה</span><b id="kpiPensionTotal">₪0</b></div>
        </div>
        <div class="progress mt-3"><div id="budgetProgress" style="width:0%"></div></div>
        <div class="mt-2 text-[.85rem] flex items-center justify-between">
          <div>הוצא עד כה: <b id="spentLabel">₪0</b></div>
          <div>נותר/חריגה: <b id="leftLabel">₪0</b></div>
        </div>
      </section>

      <section class="card p-4">
        <div class="flex items-center justify-between">
          <h3 class="text-[.95rem] font-semibold">עו"ש מתגלגל</h3>
        </div>
        <form id="formOverdraftHome" class="mt-3 space-y-2" novalidate>
          <input id="ovHomeInput" class="input w-full text-right" placeholder="סכום עו״ש לחודש הנוכחי" inputmode="decimal" />
          <button class="btn btn-prim w-full" type="submit">שמור</button>
        </form>
        <p class="text-xs text-slate-500 mt-1">היתרה מתגלגלת קדימה עד שינוי ידני.</p>
      </section>

      <section class="card p-4">
        <div class="flex items-center justify-between mb-2">
          <h3 class="text-[.95rem] font-semibold">הכנסות</h3>
          <button id="btnAddIncomeInline" type="button" class="btn btn-prim text-xs">+ מקור</button>
        </div>
        <form id="formIncomeInline" class="hidden space-y-2 mb-3" novalidate>
          <input id="incomeNet" class="input w-full text-right" placeholder="נטו" inputmode="decimal" />
          <input id="incomeGross" class="input w-full text-right" placeholder="ברוטו (אופציונלי)" inputmode="decimal" />
          <input id="incomeSource" class="input w-full" placeholder="מקור (שכר/פרילנס...)" />
          <input type="date" id="incomeDate" class="input w-full text-right" />
          <button class="btn btn-prim w-full">הוסף הכנסה</button>
        </form>
        <ul id="incomeList" class="text-[.9rem] space-y-1 max-h-40 overflow-auto"></ul>
      </section>
    </section>

    <!-- VIEW: EXPENSES -->
    <section id="view-expenses" class="space-y-4 hidden" data-view-panel="expenses">
      <div class="card p-4">
        <div class="flex items-center justify-between mb-3">
          <h3 class="text-[.95rem] font-semibold">תנועות חודשיות</h3>
        </div>
        <form id="formExpense" class="grid grid-cols-1 gap-3 mb-3" novalidate>
          <input id="expAmount" class="input text-right" placeholder="סכום (למשל 129.9)" inputmode="decimal" />
          <input id="expMerchant" class="input" placeholder="ספק/תיאור" />
          <input id="expCategory" class="input" placeholder="קטגוריה (או השאר/י ריק לשיוך חופשי)" />
          <input type="date" id="expDate" class="input text-right" />
          <button class="btn btn-prim">הוסף הוצאה</button>
        </form>
        <ul id="expenseList" class="text-[.92rem] space-y-1 max-h-[60vh] overflow-auto mt-1"></ul>
      </div>
    </section>

    <!-- VIEW: SAVINGS (פנסיה/חיסכון – תצוגת סכום כולל לעת עתה) -->
    <section id="view-savings" class="space-y-4 hidden" data-view-panel="savings">
      <div class="card p-4">
        <h3 class="text-[.95rem] font-semibold mb-2">סיכומי חיסכון ופנסיה</h3>
        <div class="kpi flex items-center justify-between"><span>סה״כ חיסכון</span><b id="savTotal">₪0</b></div>
        <div class="kpi flex items-center justify-between mt-2"><span>סה״כ פנסיה</span><b id="penTotal">₪0</b></div>
      </div>
    </section>
  </main>

  <!-- Sticky Quick Bar -->
  <nav class="fixed inset-x-0 bottom-0 bg-[#0f172a]/95 backdrop-blur border-t border-slate-800 p-3 z-30">
    <div class="container grid grid-cols-3 gap-2">
      <button id="navHome"  class="btn btn-prim text-sm w-full" type="button">בית</button>
      <button id="navExp" class="btn btn-ghost text-sm w-full" type="button">תנועות</button>
      <button id="navSav" class="btn btn-ghost text-sm w-full" type="button">חיסכון</button>
    </div>
  </nav>
  <script>
  /* ======== CONFIG ======== */
  const SUPABASE_URL  = 'https://YOUR-PROJECT.supabase.co';        // ← להחליף
  const SUPABASE_ANON = 'eyJhbGciOi...';                            // ← להחליף
  const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
  const USE_RLS_DB = true;

  /* ======== STATE + UTILS ======== */
  const ILS = new Intl.NumberFormat('he-IL',{ style:'currency', currency:'ILS', minimumFractionDigits:0, maximumFractionDigits:0 });
  const ils = n => ILS.format(Math.round(Number(n||0)));
  const pad = n => String(n).padStart(2,'0');
  const ym  = d => `${d.getFullYear()}-${pad(d.getMonth()+1)}`;
  const toYMD = (d) => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  const toNumber = v => { if (v==null) return 0; const s=String(v).replace(/[₪,\s]/g,''); const n=Number(s); return Number.isFinite(n)?n:0; };
  const esc = (s) => String(s||'').replace(/[&<>\"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));
  const uuid = () => (crypto?.randomUUID?.() || 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,c=>{const r=Math.random()*16|0,v=c==='x'?r:(r&0x3|0x8);return v.toString(16);} ));

  let CURRENT_USER = null;
  let ACTIVE_HOUSEHOLD = null;
  let ROOT = { current: ym(new Date()), months:{}, totals:{}, categories:[], accounts:[] };

  function toast(msg){
    const id='toastWrap'; let wrap=document.getElementById(id);
    if(!wrap){ wrap=document.createElement('div'); wrap.id=id; wrap.className='fixed bottom-[92px] right-4 flex flex-col gap-2 z-40'; document.body.appendChild(wrap); }
    const t=document.createElement('div'); t.className='card p-3 text-sm flex items-center gap-3'; t.textContent=msg; wrap.appendChild(t);
    setTimeout(()=>t.remove(),3000);
  }

  function monthLabel(key){ const d=new Date(key+'-01'); return d.toLocaleDateString('he-IL',{month:'long',year:'numeric'}); }
  function setCurrentMonthLabel(){ const el=document.getElementById('currentMonthLabel'); if(el) el.textContent = monthLabel(ROOT.current); }

  /* ======== AUTH (Email OTP) ======== */
  function showAuth(show){ const m=document.getElementById('authModal'); m.classList.toggle('hidden', !show); }

  async function initAuth(){
    const { data:{ session } } = await sb.auth.getSession();
    if(session?.user){ CURRENT_USER = { id:session.user.id, email:session.user.email }; showAuth(false); await afterLoginInit(); return; }
    showAuth(true);
  }

  document.getElementById('authStepEmail')?.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const email = (document.getElementById('authEmail').value||'').trim();
    const err = document.getElementById('authEmailErr'); err.classList.add('hidden');
    if(!email){ err.textContent='נא להזין אימייל'; err.classList.remove('hidden'); return; }
    document.getElementById('sendOtpBtn').disabled = true;
    const { error } = await sb.auth.signInWithOtp({ email });
    document.getElementById('sendOtpBtn').disabled = false;
    if(error){ err.textContent=error.message; err.classList.remove('hidden'); return; }
    document.getElementById('authStepEmail').classList.add('hidden');
    document.getElementById('authStepCode').classList.remove('hidden');
    document.getElementById('authCode').focus();
  });
  document.getElementById('switchEmailBtn')?.addEventListener('click', ()=>{
    document.getElementById('authStepCode').classList.add('hidden');
    document.getElementById('authStepEmail').classList.remove('hidden');
  });
  document.getElementById('resendOtpBtn')?.addEventListener('click', ()=>{
    document.getElementById('authStepEmail').dispatchEvent(new Event('submit'));
  });
  document.getElementById('authStepCode')?.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const email = (document.getElementById('authEmail').value||'').trim();
    const token = (document.getElementById('authCode').value||'').trim();
    const err = document.getElementById('authCodeErr'); err.classList.add('hidden');
    if(!/^[0-9]{6}$/.test(token)){ err.textContent='קוד לא חוקי'; err.classList.remove('hidden'); return; }
    document.getElementById('verifyOtpBtn').disabled = true;
    const { data, error } = await sb.auth.verifyOtp({ email, token, type:'email' });
    document.getElementById('verifyOtpBtn').disabled = false;
    if(error){ err.textContent=error.message; err.classList.remove('hidden'); return; }
    CURRENT_USER = { id:data.user.id, email:data.user.email };
    showAuth(false);
    await afterLoginInit();
  });

  /* ======== DB HELPERS (RLS) ======== */

  async function ensureHousehold(){
    // קורא לפונקציית הבוטסטרפ שכתבת בשלב 2
    // מחזיר hh_id. אם לא, נשלוף מהחברות.
    try{
      const { data, error } = await sb.rpc('ensure_household_and_defaults');
      if(!error && data){ return data; }
    }catch{}
    // fallback: קח את המשק-בית הראשון של המשתמש
    const { data:mem } = await sb.from('household_members').select('household_id').limit(1).maybeSingle();
    return mem?.household_id || null;
  }

  async function loadLookups(){
    const [{ data:cats }, { data:accs }] = await Promise.  /* ======== RENDERING ======== */
  function totals(){
    const list = ROOT.months[ROOT.current]?.tx||[];
    let exp=0, net=0, gross=0;
    list.forEach(t=>{
      if(t.type==='expense') exp += toNumber(t.amount);
      else { net += toNumber(t.amount); gross += toNumber(t.gross||t.amount); }
    });
    return {exp, net, gross, list};
  }

  async function renderHeader(){
    setCurrentMonthLabel();
    const m = await readMonthHeader();
    document.getElementById('kpiBudget').textContent = ils(m.total_budget||0);
    document.getElementById('kpiOverdraft').textContent = ils(m.overdraft||0);

    const t = totals();
    document.getElementById('kpiCurExp').textContent = ils(t.exp);
    const surplus = toNumber(t.net) - toNumber(m.total_budget||0);
    document.getElementById('kpiSurplus').textContent = ils(surplus);

    // Saving & Pension placeholders (שדות מסכימים לסכומים)
    document.getElementById('kpiSavingsTotal').textContent = document.getElementById('savTotal').textContent = ils(0);
    document.getElementById('kpiPensionTotal').textContent = document.getElementById('penTotal').textContent = ils(0);

    const spent = t.exp;
    const left = (m.total_budget||0) - spent;
    document.getElementById('spentLabel').textContent = ils(spent);
    document.getElementById('leftLabel').textContent = ils(left);
    const pct = Math.max(0, Math.min(100, ((m.total_budget||0) ? (spent / m.total_budget)*100 : 0)));
    document.getElementById('budgetProgress').style.width = pct + '%';
  }

  function renderLists(){
    const ulE = document.getElementById('expenseList'); ulE.innerHTML='';
    const ulI = document.getElementById('incomeList'); ulI.innerHTML='';
    const arr = (ROOT.months[ROOT.current]?.tx||[]).slice().sort((a,b)=> new Date(b.date)-new Date(a.date));
    arr.forEach(x=>{
      if(x.type==='expense'){
        const li=document.createElement('li'); li.className='row flex items-center justify-between gap-2';
        li.innerHTML = `<div class="flex flex-col">
            <span>${esc(x.category||'')}${x.merchant?' • '+esc(x.merchant):''}</span>
            <span class="text-slate-400 text-xs">${new Date(x.date).toLocaleDateString('he-IL')}</span>
          </div>
          <div class="font-semibold">${ils(x.amount)}</div>`;
        ulE.appendChild(li);
      } else {
        const li=document.createElement('li'); li.className='row flex items-center justify-between gap-2';
        li.innerHTML = `<div class="flex flex-col">
            <span class="text-emerald-300">הכנסה • ${esc(x.category||'')}</span>
            <span class="text-slate-400 text-xs">${new Date(x.date).toLocaleDateString('he-IL')}</span>
          </div>
          <div class="font-semibold">${ils(x.amount)} · ברוטו ${ils(x.gross||x.amount)}</div>`;
        ulI.appendChild(li);
      }
    });
  }

  async function renderAll(){ await renderHeader(); renderLists(); }

  /* ======== EVENTS ======== */
  // לשוניות
  document.getElementById('mainTabs')?.addEventListener('click', (e)=>{
    const btn = e.target.closest('button[data-view]'); if(!btn) return;
    const view = btn.getAttribute('data-view');
    document.querySelectorAll('[data-view-panel]').forEach(p=> p.classList.add('hidden'));
    document.getElementById(`view-${view}`)?.classList.remove('hidden');
    document.querySelectorAll('#mainTabs button').forEach(b=> b.classList.remove('on'));
    btn.classList.add('on');
  });

  // ניווט תחתון
  document.getElementById('navHome')?.addEventListener('click', ()=>{ document.querySelector('#mainTabs [data-view="home"]').click(); });
  document.getElementById('navExp') ?.addEventListener('click', ()=>{ document.querySelector('#mainTabs [data-view="expenses"]').click(); });
  document.getElementById('navSav') ?.addEventListener('click', ()=>{ document.querySelector('#mainTabs [data-view="savings"]').click(); });

  // הוספת הוצאה
  document.getElementById('formExpense')?.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const amount = toNumber(document.getElementById('expAmount').value);
    const merchant = (document.getElementById('expMerchant').value||'').trim();
    const category = (document.getElementById('expCategory').value||'').trim();
    const date = document.getElementById('expDate').value || toYMD(new Date());
    if(!amount){ toast('סכום חסר'); return; }
    const ok = await saveExpense({ amount, merchant, category, date });
    if(ok){ renderAll(); toast('נוספה הוצאה'); e.target.reset(); }
    else { toast('שגיאה בשמירה'); }
  });

  // הכנסה Inline
  document.getElementById('btnAddIncomeInline')?.addEventListener('click', ()=> document.getElementById('formIncomeInline').classList.toggle('hidden'));
  document.getElementById('formIncomeInline')?.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const net   = toNumber(document.getElementById('incomeNet').value);
    const gross = toNumber(document.getElementById('incomeGross').value) || net;
    const source= (document.getElementById('incomeSource').value||'שכר').trim();
    const date  = document.getElementById('incomeDate').value || toYMD(new Date());
    if(!net){ toast('נא להזין נטו'); return; }
    const ok = await saveIncome({ net, gross, source, date });
    if(ok){ renderAll(); toast('נוספה הכנסה'); e.target.reset(); document.getElementById('formIncomeInline').classList.add('hidden'); }
    else { toast('שגיאה בשמירה'); }
  });

  // תקציב/עו"ש
  document.getElementById('btnBudgetQuickEdit')?.addEventListener('click', async ()=>{
    const curText = document.getElementById('kpiBudget').textContent||'';
    const n = prompt('תקציב חודשי כולל (₪):', curText.replace(/[^\d.]/g,''));
    if(n==null) return;
    await setBudget(n); await renderHeader(); toast('תקציב עודכן');
  });
  document.getElementById('formOverdraftHome')?.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const v = toNumber(document.getElementById('ovHomeInput').value);
    await setOverdraft(v); await renderHeader(); toast('עו״ש עודכן'); e.target.reset();
  });

  // בחירת חודש (פשוט: prompt)
  document.getElementById('btnMonthPicker')?.addEventListener('click', async ()=>{
    const v = prompt('הכנס/י חודש בפורמט YYYY-MM (לדוגמה 2025-08):', ROOT.current);
    if(!v) return;
    ROOT.current = v;
    await ensureMonthRow(ROOT.current);
    await loadMonthData(ROOT.current);
    await renderAll();
    toast(`חודש ${monthLabel(ROOT.current)}`);
  });

  // יצוא CSV (תנועות חודשיות)
  document.getElementById('btnExportCSV')?.addEventListener('click', ()=>{
    const rows = [['type','amount','gross','category','merchant','date']];
    (ROOT.months[ROOT.current]?.tx||[]).forEach(t=>{
      rows.push([t.type, toNumber(t.amount), toNumber(t.gross||0), t.category||'', t.merchant||'', t.date||'']);
    });
    const csv = rows.map(r=> r.map(x=>{ const s=String(x??''); return s.includes(',')||s.includes('"') ? `"${s.replace(/"/g,'""')}"` : s; }).join(',')).join('\n');
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'}); const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = `wallet_${ROOT.current}.csv`; a.click(); URL.revokeObjectURL(url);
  });

  // הפעלה
  document.addEventListener('DOMContentLoaded', async ()=>{
    setCurrentMonthLabel();
    await initAuth(); // יפתח מודאל אם אין סשן
  });
  </script>
</body>
</html>
all([
      sb.from('categories').se
